
map "http://worldhealthorganization.github.io/ddcc/StructureMap/ips-to-shc" = "IPStoSHC"

uses "http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips" alias UVIPSPatient as source
uses "http://hl7.org/fhir/uv/ips/StructureDefinition/Immunization-uv-ips"  alias UVIPSImmunization as source
uses "http://hl7.org/fhir/uv/shc-vaccination/StructureDefinition/shc-patient-general-dm" alias patientDM as target
uses "http://hl7.org/fhir/uv/shc-vaccination/StructureDefinition/shc-patient-general-ad" alias patientAD as target
uses "http://hl7.org/fhir/uv/shc-vaccination/StructureDefinition/shc-patient-us-dm" alias patientUSDM as target
uses "http://hl7.org/fhir/uv/shc-vaccination/StructureDefinition/shc-patient-us-ad" alias patientUSAD as target
uses "http://hl7.org/fhir/uv/shc-vaccination/StructureDefinition/shc-vaccination-dm"  alias immunizationDM as target
uses "http://hl7.org/fhir/uv/shc-vaccination/StructureDefinition/shc-vaccination-ad" alias immunizationAD as target
uses "http://hl7.org/fhir/uv/shc-vaccination/StructureDefinition/shc-vaccination-bundle-dm" alias immunizationDMbundle as target
uses "http://hl7.org/fhir/uv/shc-vaccination/StructureDefinition/shc-vaccination-bundle-ad" alias immunizationADbundle as target


group IPStoSHC (
    source ips : UVIPSPatient,
    target shc : patientDM
    ){

    ips.entry as entry then {
        entry.resource : UVIPSPatient as patient
        then UVIPSPatienttoSHC(patient,shc) "Patient";
    } "create patient resource" ;

    ips.entry as entry then {
        entry.resource : UVIPSImmunization as immunization
        then UVIPSImmunizationtoSHC(immunization,shc) "Immunization";
    } "create immunization resource" ;
}


group UVIPSPatienttoSHC(
    source patient: UVIPSPatient,
    target shc : patientDM
    ){
    
    PatientUvIps.name only_one as name -> Patient.name = name "Name";

    PatientUvIps.name.given as givenname -> Patient.name.given = givenname "Given Name";

    PatientUvIps.name.family as familyname -> Patient.name.family = familyname "Family Name";

    PatientUvIps.birthDate as birthDate -> Patient.birthDate = birthDate "Birth Date"; // IPS is wider
    
}    


group UVIPSImmunizationtoSHC(
      source immunization: UVIPSImmunization,
      target shc : immunizationDM
      ) {

    // ClinicalDocument.section:sectionImmunizations.entry:immunization //


    ImmunizationUvIps.meta.security as security -> Immunization.meta.security = security "Security";

    ImmunizationUvIps.patient as immunopatient -> Immunization.patient = cast(immunopatient, "Reference: SHCPatientGeneralAD") "Immunization Patient";

    ImmunizationUvIps.status as immunostatus -> Immunization.status = immunostatus "Status";

    ImmunizationUvIps.lotNumber as lotNumber -> Immunization.lotNumber = lotNumber "Lot Number";

    // figure out how to nest performer and actor? 

    ImmunizationUvIps.performer as performer -> Immunization.performer = performer;

    performer.actor as actor -> performer.actor = cast(actor, "Reference: Organization");  // step 4 type conversion

    //


}